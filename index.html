<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Recordatorio de Medicamentos</title>

<style>
:root{
  --azul:#2f80ed;
  --gris:#eef1f4;
  --card:#ffffff;
  --texto:#333;
  --borde:#d0d4d9;
  --ok:#27ae60;
  --rojo:#c0392b;
}

body{
  margin:0;
  font-family: system-ui, Arial, sans-serif;
  background:var(--gris);
  color:var(--texto);
}

.header{
  padding:20px;
  background:#f7f9fb;
  text-align:center;
}

.pattern-area{ padding:20px; }

.card{
  max-width:420px;
  margin:0 auto 16px;
  background:var(--card);
  padding:22px;
  border-radius:18px;
  box-shadow:0 14px 32px rgba(0,0,0,.15);
}

.row{ margin-top:14px; }
.label{ font-size:14px; font-weight:600; margin-bottom:6px; }

input, button{
  width:100%;
  height:52px;
  box-sizing:border-box;
  padding:14px;
  border-radius:14px;
  border:1px solid var(--borde);
  font-size:16px;
}

input[type="file"]{ padding:10px; }

button{
  border:none;
  font-weight:700;
  cursor:pointer;
  margin-top:18px;
  background:var(--azul);
  color:#fff;
}

.secondary{ background:#6c757d; }
.ok{ background:var(--ok); }
.danger{ background:var(--rojo); }

.hidden{ display:none; }

.row-inline{
  display:flex;
  gap:10px;
}

.row-inline input{ flex:1; }
.row-inline button{
  width:140px;
  margin-top:0;
}

.badge{
  display:inline-block;
  background:#eef3ff;
  color:#2f80ed;
  padding:6px 10px;
  border-radius:10px;
  font-size:13px;
  margin:6px 6px 0 0;
}

.toggle{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#f3f5f7;
  padding:14px;
  border-radius:14px;
  cursor:pointer;
}

.toggle input{ display:none; }

.switch{
  width:48px;
  height:26px;
  background:#ccc;
  border-radius:13px;
  position:relative;
}

.switch::after{
  content:"";
  width:22px;
  height:22px;
  background:#fff;
  border-radius:50%;
  position:absolute;
  top:2px;
  left:2px;
}

input:checked + .switch{
  background:var(--azul);
}

input:checked + .switch::after{
  transform:translateX(22px);
}

.list-item{
  border:1px solid var(--borde);
  border-radius:14px;
  padding:14px;
  margin-top:12px;
}

img.med-img{
  width:100%;
  max-height:160px;
  object-fit:contain;
  border-radius:12px;
  margin-bottom:10px;
}
</style>
</head>

<body>

<div class="header">
  <h1>üíä Recordatorio de Medicamentos</h1>
</div>

<div class="pattern-area">

  <!-- PERFIL -->
  <div class="card" id="perfilResumen"></div>

  <!-- LISTA -->
  <div class="card">
    <h3>Tratamientos activos</h3>
    <div id="lista"></div>
    <button onclick="mostrarForm()">Agregar medicamento</button>
  </div>

  <!-- FORMULARIO -->
  <div class="card hidden" id="formMed">

    <div class="row">
      <div class="label">Nombre del medicamento</div>
      <input id="medNombre">
    </div>

    <div class="row">
      <div class="label">Dosis</div>
      <input id="medDosis">
    </div>

    <div class="row">
      <div class="label">Lugar donde se guarda</div>
      <input id="medLugar">
    </div>

    <div class="row">
      <div class="label">Foto de la caja</div>
      <input type="file" id="medFoto" accept="image/*">
    </div>

    <div class="row toggle" onclick="togglePermanente()">
      <span>Medicamento permanente</span>
      <label>
        <input type="checkbox" id="medPermanente">
        <div class="switch"></div>
      </label>
    </div>

    <div class="row" id="diasRow">
      <div class="label">D√≠as de duraci√≥n</div>
      <input type="number" id="medDias">
    </div>

    <div class="row">
      <div class="label">Horarios</div>
      <div class="row-inline">
        <input type="time" id="horaInput">
        <button class="secondary" onclick="agregarHora()">Agregar</button>
      </div>
      <div id="horas"></div>
    </div>

    <button class="ok" onclick="guardarMed()">Guardar medicamento</button>
    <button class="secondary" onclick="ocultarForm()">Cancelar</button>
  </div>

</div>

<script>
// ===== USUARIO =====
const usuario = JSON.parse(localStorage.getItem("usuario"));
perfilResumen.innerHTML = `
<strong>${usuario.nombre}</strong><br>
Cuidador: ${usuario.cuidadorNombre}<br>
Tel: ${usuario.cuidadorTelefono}<br>
Voz: ${usuario.voz ? "S√≠" : "No"} ¬∑ Vibraci√≥n: ${usuario.vibracion ? "S√≠" : "No"}
`;

// ===== DATOS =====
let tratamientos = JSON.parse(localStorage.getItem("tratamientos")) || [];
let historialTomas = JSON.parse(localStorage.getItem("historialTomas")) || [];
let alarmasDisparadas = {};
let horasTemp = [];
let fotoTemp = null;

// ===== PERMISOS =====
if("Notification" in window && Notification.permission !== "granted"){
  Notification.requestPermission();
}

// ===== FOTO =====
medFoto.addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;
  const r = new FileReader();
  r.onload = ()=> fotoTemp = r.result;
  r.readAsDataURL(file);
});

// ===== UI =====
function togglePermanente(){
  medPermanente.checked = !medPermanente.checked;
  diasRow.style.display = medPermanente.checked ? "none" : "block";
}

function mostrarForm(){ formMed.classList.remove("hidden"); }
function ocultarForm(){
  formMed.classList.add("hidden");
  horasTemp=[]; horas.innerHTML="";
  medNombre.value=medDosis.value=medLugar.value=medDias.value="";
  medFoto.value=""; fotoTemp=null;
}

function agregarHora(){
  if(!horaInput.value) return;
  horasTemp.push(horaInput.value);
  horas.innerHTML = horasTemp.map(h=>`<span class="badge">${h}</span>`).join("");
  horaInput.value="";
}

function guardarMed(){
  if(!medNombre.value || !medDosis.value || !medLugar.value || horasTemp.length===0){
    alert("Complete todos los campos");
    return;
  }

  tratamientos.push({
    nombre: medNombre.value,
    dosis: medDosis.value,
    lugar: medLugar.value,
    horarios: horasTemp,
    dias: medPermanente.checked ? null : medDias.value,
    permanente: medPermanente.checked,
    foto: fotoTemp,
    activo:true
  });

  localStorage.setItem("tratamientos", JSON.stringify(tratamientos));
  ocultarForm();
  renderLista();
}

function eliminar(i){
  tratamientos.splice(i,1);
  localStorage.setItem("tratamientos", JSON.stringify(tratamientos));
  renderLista();
}

function renderLista(){
  lista.innerHTML="";
  tratamientos.forEach((t,i)=>{
    lista.innerHTML+=`
      <div class="list-item">
        ${t.foto?`<img class="med-img" src="${t.foto}">`:""}
        <strong>${t.nombre}</strong><br>
        Dosis: ${t.dosis}<br>
        üìç ${t.lugar}<br>
        ${t.permanente?"‚ôæÔ∏è Permanente":`‚è≥ ${t.dias} d√≠as`}<br>
        Horarios: ${t.horarios.join(", ")}
        <button class="secondary" onclick="eliminar(${i})">Eliminar</button>
      </div>`;
  });
}

// ===== ALARMAS =====
function iniciarAlarmas(){
  setInterval(verificarAlarmas,60000);
}

function verificarAlarmas(){
  const ahora = new Date();
  const horaActual = ahora.toTimeString().slice(0,5);
  const hoy = ahora.toISOString().slice(0,10);

  tratamientos.forEach(t=>{
    if(!t.activo) return;
    t.horarios.forEach(h=>{
      const clave = `${t.nombre}-${h}-${hoy}`;
      if(h===horaActual && !alarmasDisparadas[clave]){
        alarmasDisparadas[clave]=true;
        dispararAlarma(t,h,hoy);
      }
    });
  });
}

function dispararAlarma(t,hora,fecha){
  // Notificaci√≥n
  if(Notification.permission==="granted"){
    new Notification("Medicamento",{
      body:`${usuario.nombre}, tome ${t.nombre}. Est√° en ${t.lugar}.`,
      icon:t.foto||undefined
    });
  }

  // Vibraci√≥n
  if(usuario.vibracion && navigator.vibrate){
    navigator.vibrate([500,300,500]);
  }

  // Voz
  if(usuario.voz && "speechSynthesis" in window){
    const msg = new SpeechSynthesisUtterance(
      `${usuario.nombre}, es hora de tomar su medicamento ${t.nombre}. Est√° en ${t.lugar}.`
    );
    msg.lang="es-ES";
    speechSynthesis.speak(msg);
  }

  mostrarPopup(t,hora,fecha);
}

function mostrarPopup(t,hora,fecha){
  const p=document.createElement("div");
  p.className="card";
  p.style.position="fixed";
  p.style.bottom="20px";
  p.style.left="50%";
  p.style.transform="translateX(-50%)";
  p.style.zIndex="9999";

  p.innerHTML=`
    <strong>${t.nombre}</strong><br>
    Hora: ${hora}
    <button class="ok">Tomado</button>
    <button class="danger">Omitido</button>
  `;

  document.body.appendChild(p);

  p.querySelector(".ok").onclick=()=>registrar(t,hora,fecha,"Tomado",p);
  p.querySelector(".danger").onclick=()=>registrar(t,hora,fecha,"Omitido",p);
}

function registrar(t,hora,fecha,estado,p){
  historialTomas.push({medicamento:t.nombre,hora,fecha,estado});
  localStorage.setItem("historialTomas",JSON.stringify(historialTomas));
  p.remove();

  if(estado==="Omitido"){
    alert(`Avisar al cuidador: ${usuario.cuidadorTelefono}`);
  }
}

renderLista();
iniciarAlarmas();
</script>

</body>
</html>
